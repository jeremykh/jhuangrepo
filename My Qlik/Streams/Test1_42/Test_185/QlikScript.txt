///$tab Main
SET ThousandSep=',';
SET DecimalSep='.';
SET MoneyThousandSep=',';
SET MoneyDecimalSep='.';
SET MoneyFormat='$#,##0.00;($#,##0.00)';
SET TimeFormat='h:mm:ss TT';
SET DateFormat='M/D/YYYY';
SET TimestampFormat='M/D/YYYY h:mm:ss[.fff] TT';
SET FirstWeekDay=6;
SET BrokenWeeks=1;
SET ReferenceDay=0;
SET FirstMonthOfYear=1;
SET CollationLocale='en-US';
SET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';
SET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';
SET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';
SET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';

///$tab Auto-generated section
///$autogenerated

__cityAliasesBase:
LOAD
	Alias AS [__City],
	geoKey AS [__geoKey],
	CountryCode AS [__CityCountryCode]
FROM [lib://AttachedFiles/cityAliases.qvd]
(qvd);

__cityGeoBase:
LOAD
	geoKey AS [__geoKey],
	geoPoint AS [__GeoPoint]
FROM [lib://AttachedFiles/cityGeo.qvd]
(qvd);

__countryAliasesBase:
LOAD
	Alias AS [__Country],
	ISO3Code AS [__ISO3Code]
FROM [lib://AttachedFiles/countryAliases.qvd]
(qvd);

__countryGeoBase:
LOAD
	ISO3Code AS [__ISO3Code],
	ISO2Code AS [__ISO2Code],
	Polygon AS [__Polygon]
FROM [lib://AttachedFiles/countryGeo.qvd]
(qvd);

__countryCodeAndCityName2Key:
MAPPING LOAD
	__CityCountryCode & __City,
	__geoKey
RESIDENT __cityAliasesBase;

__cityKey2GeoPoint:
MAPPING LOAD
	__geoKey,
	__GeoPoint
RESIDENT __cityGeoBase;

__countryName2IsoThree:
MAPPING LOAD
	__Country,
	__ISO3Code
RESIDENT __countryAliasesBase;

__countryCodeIsoThree2Polygon:
MAPPING LOAD
	__ISO3Code,
	__Polygon
RESIDENT __countryGeoBase;

__countryCodeIsoTwo2Polygon:
MAPPING LOAD
	__ISO2Code,
	__Polygon
RESIDENT __countryGeoBase;

__cityName2Key:
MAPPING LOAD
	__City,
	__geoKey
RESIDENT __cityAliasesBase;

[Customers]:
LOAD 
	[Address],
	[City],
	[ContactName],
	[Country],
	[Region],
	[Customer],
	[CustomerID],
	[Fax],
	[Phone],
	[PostalCode],
	[CountryCode],
	[Latitude],
	[Longitude],
	APPLYMAP('__cityKey2GeoPoint', APPLYMAP('__countryCodeAndCityName2Key',APPLYMAP('__countryName2IsoThree', LOWER([Country])) & LOWER([City])), '-') AS [Customers.City_GeoInfo],
	APPLYMAP( '__countryCodeIsoThree2Polygon', APPLYMAP('__countryName2IsoThree', LOWER([Country])), '-') AS [Customers.Country_GeoInfo],
	APPLYMAP( '__countryCodeIsoTwo2Polygon', UPPER([CountryCode]), '-') AS [Customers.CountryCode_GeoInfo],
	GeoMakePoint([Latitude], [Longitude]) AS [Longitude_Latitude]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Customers);

[Employees]:
LOAD [EmployeeID],
	[Extension],
	[EmployeeName],
	[EmployeeGender],
	[Hire Date],
	[Office],
	[Supervisor],
	[JobTitle],
	[AnnualSalary],
	[SalesTarget]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Employees);

[Offices]:
LOAD 
	[Office],
	[OfficeLocation],
	APPLYMAP('__cityKey2GeoPoint', APPLYMAP('__cityName2Key', LOWER([OfficeLocation])), '-') AS [Offices.OfficeLocation_GeoInfo]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Offices);

[OrderHeader]:
LOAD [OrderDate],
	[CustomerID],
	[EmployeeID],
	[ShippingCost],
	[OrderID],
	[ShippingCompany],
	[DeliveryDate]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is OrderHeader);

[Category]:
LOAD [CategoryID],
	[CategoryName],
	[Department],
	[Description]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Category);

[Products]:
LOAD [ProductID],
	[CategoryID],
	[ProductName],
	[SupplierID]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Products);

[OrderDetails]:
LOAD [OrderID],
	[ProductID],
	[Quantity],
	[Sales],
	[Discount],
	[CostOfSales],
	[GrossProfit]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is OrderDetails);

[Suppliers]:
LOAD 
	[SupplierID],
	[Supplier],
	[SupplierContact],
	[SupplierCountry],
	APPLYMAP( '__countryCodeIsoThree2Polygon', APPLYMAP('__countryName2IsoThree', LOWER([SupplierCountry])), '-') AS [Suppliers.SupplierCountry_GeoInfo]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Suppliers);

[Territories]:
LOAD [EmployeeID],
	[TerritoryID]
 FROM [lib://AttachedFiles/International Apparel Data.xlsx]
(ooxml, embedded labels, table is Territories);

TAG FIELD [City] WITH "$geoname" ;
TAG FIELD [Customers.City_GeoInfo] WITH "$geopoint" ;
TAG FIELD [Country] WITH "$geoname" ;
TAG FIELD [Customers.Country_GeoInfo] WITH "$geopolygon" ;
TAG FIELD [CountryCode] WITH "$geoname" ;
TAG FIELD [Customers.CountryCode_GeoInfo] WITH "$geopolygon" ;
TAG FIELD [OfficeLocation] WITH "$geoname" ;
TAG FIELD [Offices.OfficeLocation_GeoInfo] WITH "$geopoint" ;
TAG FIELD [SupplierCountry] WITH "$geoname" ;
TAG FIELD [Suppliers.SupplierCountry_GeoInfo] WITH "$geopolygon" ;

DROP TABLES __cityAliasesBase, __cityGeoBase, __countryAliasesBase, __countryGeoBase;
[autoCalendar]: 
  DECLARE FIELD DEFINITION Tagged ('$date')
FIELDS
  Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),
  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter'),
  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$axis', '$yearquarter'),
  Month($1) AS [Month] Tagged ('$month'),
  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth'),
  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber'),
  Date(Floor($1)) AS [Date] Tagged ('$date');

DERIVE FIELDS FROM FIELDS [Hire Date], [OrderDate], [DeliveryDate] USING [autoCalendar] ;